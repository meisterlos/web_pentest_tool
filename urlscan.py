import argparse
import requests
from bs4 import BeautifulSoup
from urllib.parse import urlparse, urljoin
import time

MAX_DEPTH = 100
MAX_RUN_TIME = 180  # 3 dakika
start_time = time.time()

def dizinleri_bul(url, depth=0, scanned=0, base_domain=''):
    try:
        if depth > MAX_DEPTH or base_domain == '' or time.time() - start_time > MAX_RUN_TIME:
            return set()

        response = requests.get(url)
        if response.status_code != 200:
            return set()

        soup = BeautifulSoup(response.content, 'html.parser')
        links = soup.find_all('a', href=True)
        dizinler = set()

        for link in links:
            href = link['href']
            if href.startswith('http') and base_domain in href and href.endswith('/'):
                dizinler.add(href)
                print("[*] Dizin bulundu:", href)
                absolute_url = urljoin(url, href)
                parsed_url = urlparse(absolute_url)
                if parsed_url.netloc == base_domain:
                    dizinler.update(dizinleri_bul(absolute_url, depth + 1, scanned=len(links), base_domain=base_domain))

        return dizinler

    except Exception as e:
        print("Hata:", e)
        return set()

def kaydet(dizinler, output_file):
    try:
        with open(output_file, 'w') as f:
            for dizin in dizinler:
                f.write(dizin + '\n')
        print("[+] Dizinler başarıyla kaydedildi.")
    except Exception as e:
        print("Kaydetme hatası:", e)

def main():
    parser = argparse.ArgumentParser(description="Web sitesindeki dizinleri bulan program")
    parser.add_argument("-u", "--url", help="Taranacak web sitesinin URL'si", required=True)
    parser.add_argument("-o", "--output", help="Bulunan dizinlerin kaydedileceği dosyanın adı", required=True)
    args = parser.parse_args()

    url = args.url
    output_file = args.output

    base_domain = urlparse(url).netloc
    dizinler = dizinleri_bul(url, base_domain=base_domain)
    
    if dizinler:
        kaydet(dizinler, output_file)
    else:
        print("Hiçbir dizin bulunamadı.")

if __name__ == "__main__":
    main()